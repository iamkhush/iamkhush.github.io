<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.72.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Understanding Postgre's Wire Protocol &#183; Ankush Chadda</title><meta name=description content><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/print.css media=print><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/poole.css><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/syntax.css><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/hyde.css><link type=text/css rel=stylesheet href=/css/print.css media=print><link type=text/css rel=stylesheet href=/css/poole.css><link type=text/css rel=stylesheet href=/css/syntax.css><link type=text/css rel=stylesheet href=/css/hyde.css><link href=/css/all.css rel=stylesheet><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://ankushchadda.in/><h1>Ankush Chadda</h1></a><p class=lead>Almost Geek</p></div><nav><ul class=sidebar-nav><li><a href=https://ankushchadda.in/>Home</a></li><li><a href=/about>About me</a></li><li><a href=/posts>All Posts</a></li><li><a href=/series>Series</a></li><li><a href=/tags>Tags</a></li></ul><a href=http://twitter.com/iamkhush title=Twiiter><i class="fab fa-twitter-square"></i></a>&nbsp;&nbsp;
<a href=https://www.linkedin.com/in/iamkhush/ title=Linkedin><i class="fab fa-linkedin"></i></a>&nbsp;&nbsp;
<a href=https://github.com/iamkhush/ title=Github><i class="fab fa-github-square"></i></a>&nbsp;&nbsp;
<a href=/index.xml title=RSS><i class="fa fa-rss"></i></a>&nbsp;&nbsp;</nav><p>Â© Ankush Chadda. All rights reserved</p></div></aside><main class="content container"><div class=post><h1>Understanding Postgre's Wire Protocol</h1><time datetime=2020-09-26T00:04:06+0200 class=post-date>Sat, Sep 26, 2020</time><h2 id=introduction-to-postgres-wire-protocol>Introduction to Postgres Wire Protocol</h2><p>Postgres uses <em>Message based protocol</em> to comunicate between clients( for eg. <code>psql</code>) and DB server.
I will try to summarize some aspects of the protocol.</p><ul><li>Current version is 3.0</li><li>Supports TCP/IP and Unix domain sockets (IPC Sockets).</li><li>Each connection goes through 3 phases -<ul><li><a href=#startup-phase>Startup Phase</a></li><li><a href=#operations-in-normal-phase>Normal Phase</a></li><li><a href=#termination-phase>Termination Phase</a></li></ul></li></ul><p><img src=/postgres/conn-phases.png alt="Connection Phases between Client and PG server"></p><h3 id=startup-phase>Startup Phase</h3><ul><li>Client opens connection by sending startup message ( See 1 in the figure above )<ul><li>The structure of a startup message is as follows -</li></ul></li></ul><table><thead><tr><th>4 byte</th><th>4 bytes</th><th></th></tr></thead><tbody><tr><td>Length of message</td><td>Protocol Version</td><td>Message Data like username, database name etc</td></tr></tbody></table><ul><li>Server checks the message data from above and also its own config files, to determine the response, which can be one of the following -<ul><li>A success response (<code>AuthenticationOk</code>) ( 3a in the figure )</li><li>An error response (<code>ErrorResponse</code>) ( 3b in the figure )</li><li>Authentication related messages( like <code>AuthenticationMD5Password</code>)</li><li>Protocol negotiation response (<code>NegotiateProtocolVersion</code>)</li></ul></li><li>If the response was <code>AuthenticationOk</code> then server sends some more messages( 4 in the figure ), but the most important of them is <code>ReadyForQuery</code> message( 5 in the figure ). Once sent, the next phase (Normal phase) is initiated.</li><li>Server launches a new process for each client connection.</li><li>Also interestingly, other than the startup message, the message format is</li></ul><table><thead><tr><th>1 byte</th><th>4 bytes</th><th></th></tr></thead><tbody><tr><td><a href=https://www.postgresql.org/docs/current/protocol-message-formats.html>Message Type</a></td><td>Length of message</td><td>Message Data depending on Message Type</td></tr></tbody></table><h3 id=operations-in-normal-phase>Operations in Normal Phase</h3><ul><li>Client sends query message and Server responds accordingly.</li><li>When server parses the query, it does the following steps -<ol><li><em>Parse</em> step which creates a prepared statement from a textual query. It may have a name, in which case it can be reused multiple times, hence optimizing response times. This step can be done manually using <code>PREPARE</code> SQL.</li><li><em>Bind</em> step which creates a portal given a prepared statement (from step 1) and values for any parameters. Again, it may have a name as well. Query planning happens after this step completes. Can be done by SQL <code>CREATE CURSOR</code> and <code>FETCH</code>.</li><li><em>Execute</em> step which runs the portal&rsquo;s query. Also can be called manually by SQL <code>EXECUTE</code>.</li><li><em>Sync</em> step which completes the query transaction.</li></ol></li><li>Query can use either of 2 sub-protocols -<ul><li>A <strong>simple query protocol</strong> in which only a textual SQL query is sent.<ul><li>Backend creates an unnamed prepared statement, portal and executes it.</li><li>It then responds with one or more response messages, finally ending the response with <code>ReadyForQuery</code> Message.</li><li>Interestingly, if the query contains multiple SQL statements ( seperated with a <code>;</code>), a <code>CommandComplete</code> is sent after each statement is executed. However <code>ReadyForQuery</code> is only issued after all queries are completed. If there is any error raised in any one of them, all the statements are rolled back, first <code>ErrorResponse</code> is responded followed by a <code>ReadyForQuery</code></li><li>Also, there is no need for client to wait for <code>ReadyForQuery</code> and can send further queries if it wants.</li></ul></li><li>An <strong>Extended Query Protocol</strong> does the 3 steps as seperate statements.<ul><li>For response of <em>Parse</em> step, <code>ParseComplete</code> response is sent.</li><li>For response of <em>Bind</em> step, <code>BindComplete</code> response is sent.</li><li>For response of <em>Execute</em> step, <code>CommandComplete</code> response is sent.</li><li>For response of <em>Sync</em> step, <code>ReadyForQuery</code> response is sent.</li><li>Important to note that it cannot parse multiple SQL statements, unlike Simple Query protocol.</li><li>A <em>Sync</em> needs to be sent everytime to end a transaction.</li><li>However, one can send multiple <em>Bind</em> and <em>Execute</em> messages, for same portal without waiting for <code>ReadyForQuery</code>.<ul><li>A web application can use this feature to get async responses of its queries.</li></ul></li></ul></li></ul></li><li>One important caveat is that a prepared statement cannot be shared between different processes / connections. It only lives for 1 session.</li><li>Checkout my pg-client implementation script <a href=https://gist.github.com/iamkhush/8612c62be915e554d9430b65fcd7d2d9>here</a></li></ul><h3 id=termination-phase>Termination Phase</h3><ul><li>Normally initiated by client</li><li>Server responds and roll backs any incomplete transactions.</li></ul><p>Sources -</p><ul><li><a href=https://www.postgresql.org/docs/12/>https://www.postgresql.org/docs/12/</a></li></ul></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"ankushchaddablog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56883493-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>