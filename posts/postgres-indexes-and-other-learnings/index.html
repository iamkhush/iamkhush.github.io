<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Postgres Indexes, PL/pgSQL and other learnings - Ankush Chadda</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Postgres Indexes, PL/pgSQL and other learnings"><meta itemprop=description content="Recently I had to do a bit of reading on building Indexes in Postgres. Intrestingly I found some striking features about indexing types in Postgres
Extensions Postgres has a collection of extensions/modules. These are basically set of functions. One such module is pg_trgm. Quoting from the documentation- &ldquo;pg_trgm provides functions and operators for determining the similarity of ASCII alphanumeric text based on trigram matching, as well as index operator classes that support fast searching for similar strings&rdquo; Documentation"><meta itemprop=datePublished content="2016-02-02T01:30:01+05:30"><meta itemprop=dateModified content="2016-02-02T01:30:01+05:30"><meta itemprop=wordCount content="551"><meta itemprop=keywords content="postgres,databases,plsql,"><meta property="og:title" content="Postgres Indexes, PL/pgSQL and other learnings"><meta property="og:description" content="Recently I had to do a bit of reading on building Indexes in Postgres. Intrestingly I found some striking features about indexing types in Postgres
Extensions Postgres has a collection of extensions/modules. These are basically set of functions. One such module is pg_trgm. Quoting from the documentation- &ldquo;pg_trgm provides functions and operators for determining the similarity of ASCII alphanumeric text based on trigram matching, as well as index operator classes that support fast searching for similar strings&rdquo; Documentation"><meta property="og:type" content="article"><meta property="og:url" content="https://ankushchadda.in/posts/postgres-indexes-and-other-learnings/"><meta property="article:published_time" content="2016-02-02T01:30:01+05:30"><meta property="article:modified_time" content="2016-02-02T01:30:01+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Postgres Indexes, PL/pgSQL and other learnings"><meta name=twitter:description content="Recently I had to do a bit of reading on building Indexes in Postgres. Intrestingly I found some striking features about indexing types in Postgres
Extensions Postgres has a collection of extensions/modules. These are basically set of functions. One such module is pg_trgm. Quoting from the documentation- &ldquo;pg_trgm provides functions and operators for determining the similarity of ASCII alphanumeric text based on trigram matching, as well as index operator classes that support fast searching for similar strings&rdquo; Documentation"><link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://ankushchadda.in/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://ankushchadda.in/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://ankushchadda.in/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://ankushchadda.in/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://ankushchadda.in/><img src=/profile.png alt="Ankush Chadda"></a></div><h1 class=site-title><a href=https://ankushchadda.in/>Ankush Chadda</a></h1><div class=site-description><p>Wanderer, Occassional Coder</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/iamkhush title=Github><i data-feather=github></i></a></li><li><a href=http://facebook.com/iamkhush title=Facebook><i data-feather=facebook></i></a></li><li><a href=http://twitter.com/iamkhush title=Twitter><i data-feather=twitter></i></a></li><li><a href=http://linkedin.com/in/iamkhush title=Linkedin><i data-feather=linkedin></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li></ul></nav><span class=scheme-toggle><a href=# id=scheme-toggle></a></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>02</span>
<span class=rest>Feb 2016</span></div></div><div class=matter><h1 class=title>Postgres Indexes, PL/pgSQL and other learnings</h1></div></div><div class=markdown><p>Recently I had to do a bit of reading on building Indexes in Postgres. Intrestingly I found some striking features about indexing types in Postgres</p><h2 id=extensions>Extensions</h2><p>Postgres has a collection of extensions/modules. These are basically set of functions. One such module is <code>pg_trgm</code>. Quoting from the documentation- &ldquo;pg_trgm provides functions and operators for determining the similarity of ASCII alphanumeric text based on trigram matching, as well as index operator classes that support fast searching for similar strings&rdquo; <a href=http://www.postgresql.org/docs/9.1/static/pgtrgm.html>Documentation</a></p><p>To use extensions one has to enable / create extensions. Extensions like pg_trgm are built in, meaning they dont have any other depenedencies, you can build them whenever you need to use them.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>CREATE</span> <span style=color:#00f>EXTENSION</span> pg_trgm;</code></pre></div><p>One interesting function that I would like to experiment on is <em>similarity</em> which basically returns a number ( between 0 and 1 ) indicating how similar the two arguments are, 1 for when comparing identical strings</p><h2 id=the-trigram-indexes>The Trigram Indexes</h2><p>Now apart from this just plug n play functionality, pg_trgm also provides us GIN and GiST indexes. They allow very fast similarity searches ( using the method above) and also support LIKE and ILIKE queries.</p><p>As stated in the documentation, GIN is generally faster than GiST index, but GIN is much more suited for static data.</p><p>For my use case , I needed to implement a full text search, from 5 million rows. Using the index , search got completed in couple of 8ms, whereas it took about 17 secs. I am quite happy with the results.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>CREATE</span> <span style=color:#00f>INDEX</span> trgm_idx <span style=color:#00f>ON</span> test_trgm <span style=color:#00f>USING</span> gin (t gin_trgm_ops);</code></pre></div><p>Check this <a href=http://blog.2ndquadrant.com/text-search-strategies-in-postgresql/>page</a> for indexing strategies.</p><p>Official documentation about text search <a href=http://www.postgresql.org/docs/9.5/static/textsearch.html>www.postgresql.org</a></p><h2 id=cons-of-the-trigram-indexes>Cons of the Trigram Indexes</h2><p>Even though using GIN solved the issues, there were two issues that came to me</p><ul><li>Firstly, the size of GIN Index was around 2GBs for a table having size of 700MBs only</li><li>Secondly, since this is a trigram index, search for words with less than 3 letters couldnt use the index.</li></ul><p>For the second problem, we used a simple hack. Since the use of index was giving much better performance, we decided to search for words less than 3 letters, in memory/code.</p><h2 id=partial-indexes>Partial Indexes</h2><p>Partial indexes, as the name suggests, builds indexes for only rows that fall under the condition( called predicate ) we mention while creating the index.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>CREATE</span> <span style=color:#00f>INDEX</span> orders_unbilled_index <span style=color:#00f>ON</span> orders (order_nr)
    <span style=color:#00f>WHERE</span> billed <span style=color:#00f>is</span> <span style=color:#00f>not</span> <span style=color:#00f>true</span>;</code></pre></div><p>They save space and are also easier to update as compared to full table indexes.</p><h2 id=plpgsql---sql-procedural-language>PL/pgSQL - SQL Procedural Language</h2><p>One last thing I learnt was PL/pgSQL. Its a procedural language in Postgres. I wanted to build partial indexes and wanted to iterate over loops. So I wrote a procedural script and ran it. One example below</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>do</span> <span>$$</span>
<span style=color:#00f>begin</span>
<span style=color:#00f>for</span> i <span style=color:#00f>in</span> 1..97 <span style=color:#00f>loop</span>
<span style=color:#00f>execute</span> format(<span style=color:#a31515>&#39;drop index table_%s&#39;</span>,i);
<span style=color:#00f>end</span> <span style=color:#00f>loop</span>;
<span style=color:#00f>end</span>;
<span>$$</span> <span style=color:#00f>LANGUAGE</span> plpgsql;</code></pre></div><p>Helpful documentation and examples can be seen <a href=http://www.postgresql.org/docs/current/static/plpgsql.html>here</a>.</p><h2 id=bigram-indexes>Bigram Indexes</h2><p>Now, similar to Trigram Indexes, Postgres also supports Bigram Indexes. The module name is called <code>pg_bigm</code>. Now this module is not available on the fly in postgres.</p><p>The module can be accessed here. This module needs to be fetched and compiled before you can use it.</p><p>Unlike Trigram, it used 2 letters grams or tokens. Also it supports on GIN Index. More elaborate comparision is available on the link above.</p></div><div class=tags><ul class=flat><li><a href=/tags/postgres>postgres</a></li><li><a href=/tags/databases>databases</a></li><li><a href=/tags/plsql>plsql</a></li></ul></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='Ankush Chadda\u0027s HomeSite';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class="footer wrapper"><nav class=nav><div>2016 © Copyright notice | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56883493-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></body></html>