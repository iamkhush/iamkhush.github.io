<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.72.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Postgres Indexes, PL/pgSQL and other learnings &#183; Ankush Chadda</title><meta name=description content><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/print.css media=print><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/poole.css><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/syntax.css><link type=text/css rel=stylesheet href=https://ankushchadda.in/css/hyde.css><link href=/css/all.css rel=stylesheet><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-08><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://ankushchadda.in/><h1>Ankush Chadda</h1></a><p class=lead>Occassional Coder</p></div><nav><ul class=sidebar-nav><li><a href=https://ankushchadda.in/>Home</a></li><li><a href=/about>About me</a></li><li><a href=/posts>All Posts</a></li><li><a href=/index.xml>Feed</a></li><li><a href=/tags>Tags</a></li></ul><a href=http://twitter.com/iamkhush><i class="fab fa-twitter-square"></i></a>&nbsp;&nbsp;
<a href=https://www.linkedin.com/in/iamkhush/><i class="fab fa-linkedin"></i></a>&nbsp;&nbsp;
<a href=https://github.com/iamkhush/><i class="fab fa-github-square"></i></a>&nbsp;&nbsp;
<a href=mailto:aoswebdevelopers@gmail.com><i class="fas fa-at"></i></a>&nbsp;&nbsp;</nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Postgres Indexes, PL/pgSQL and other learnings</h1><time datetime=2016-02-02T01:30:01+0530 class=post-date>Tue, Feb 2, 2016</time><p>Recently I had to do a bit of reading on building Indexes in Postgres. Intrestingly I found some striking features about indexing types in Postgres</p><h2 id=extensions>Extensions</h2><p>Postgres has a collection of extensions/modules. These are basically set of functions. One such module is <code>pg_trgm</code>. Quoting from the documentation- &ldquo;pg_trgm provides functions and operators for determining the similarity of ASCII alphanumeric text based on trigram matching, as well as index operator classes that support fast searching for similar strings&rdquo; <a href=http://www.postgresql.org/docs/9.1/static/pgtrgm.html>Documentation</a></p><p>To use extensions one has to enable / create extensions. Extensions like pg_trgm are built in, meaning they dont have any other depenedencies, you can build them whenever you need to use them.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>CREATE</span> <span style=color:#00f>EXTENSION</span> pg_trgm;</code></pre></div><p>One interesting function that I would like to experiment on is <em>similarity</em> which basically returns a number ( between 0 and 1 ) indicating how similar the two arguments are, 1 for when comparing identical strings</p><h2 id=the-trigram-indexes>The Trigram Indexes</h2><p>Now apart from this just plug n play functionality, pg_trgm also provides us GIN and GiST indexes. They allow very fast similarity searches ( using the method above) and also support LIKE and ILIKE queries.</p><p>As stated in the documentation, GIN is generally faster than GiST index, but GIN is much more suited for static data.</p><p>For my use case , I needed to implement a full text search, from 5 million rows. Using the index , search got completed in couple of 8ms, whereas it took about 17 secs. I am quite happy with the results.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>CREATE</span> <span style=color:#00f>INDEX</span> trgm_idx <span style=color:#00f>ON</span> test_trgm <span style=color:#00f>USING</span> gin (t gin_trgm_ops);</code></pre></div><p>Check this <a href=http://blog.2ndquadrant.com/text-search-strategies-in-postgresql/>page</a> for indexing strategies.</p><p>Official documentation about text search <a href=http://www.postgresql.org/docs/9.5/static/textsearch.html>www.postgresql.org</a></p><h2 id=cons-of-the-trigram-indexes>Cons of the Trigram Indexes</h2><p>Even though using GIN solved the issues, there were two issues that came to me</p><ul><li>Firstly, the size of GIN Index was around 2GBs for a table having size of 700MBs only</li><li>Secondly, since this is a trigram index, search for words with less than 3 letters couldnt use the index.</li></ul><p>For the second problem, we used a simple hack. Since the use of index was giving much better performance, we decided to search for words less than 3 letters, in memory/code.</p><h2 id=partial-indexes>Partial Indexes</h2><p>Partial indexes, as the name suggests, builds indexes for only rows that fall under the condition( called predicate ) we mention while creating the index.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>CREATE</span> <span style=color:#00f>INDEX</span> orders_unbilled_index <span style=color:#00f>ON</span> orders (order_nr)
    <span style=color:#00f>WHERE</span> billed <span style=color:#00f>is</span> <span style=color:#00f>not</span> <span style=color:#00f>true</span>;</code></pre></div><p>They save space and are also easier to update as compared to full table indexes.</p><h2 id=plpgsql---sql-procedural-language>PL/pgSQL - SQL Procedural Language</h2><p>One last thing I learnt was PL/pgSQL. Its a procedural language in Postgres. I wanted to build partial indexes and wanted to iterate over loops. So I wrote a procedural script and ran it. One example below</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plpgsql data-lang=plpgsql><span style=color:#00f>do</span> <span>$$</span>
<span style=color:#00f>begin</span>
<span style=color:#00f>for</span> i <span style=color:#00f>in</span> 1..97 <span style=color:#00f>loop</span>
<span style=color:#00f>execute</span> format(<span style=color:#a31515>&#39;drop index table_%s&#39;</span>,i);
<span style=color:#00f>end</span> <span style=color:#00f>loop</span>;
<span style=color:#00f>end</span>;
<span>$$</span> <span style=color:#00f>LANGUAGE</span> plpgsql;</code></pre></div><p>Helpful documentation and examples can be seen <a href=http://www.postgresql.org/docs/current/static/plpgsql.html>here</a>.</p><h2 id=bigram-indexes>Bigram Indexes</h2><p>Now, similar to Trigram Indexes, Postgres also supports Bigram Indexes. The module name is called <code>pg_bigm</code>. Now this module is not available on the fly in postgres.</p><p>The module can be accessed here. This module needs to be fetched and compiled before you can use it.</p><p>Unlike Trigram, it used 2 letters grams or tokens. Also it supports on GIN Index. More elaborate comparision is available on the link above.</p></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){this.page.url='http:\/\/blog.ankushchadda.in\/posts\/02-02-2016-postgres-indexes-and-other-learnings.html';};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"ankushchaddablog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56883493-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>